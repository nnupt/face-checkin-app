// js/main.js

// 1. ประกาศตัวแปรสำหรับเก็บฐานข้อมูล Descriptors
let faceMatcher = null; 

// 2. ฟังก์ชันโหลดและเข้ารหัสใบหน้า
async function loadLabeledFaceDescriptors() {
    const descriptors = [];
    
    // วนลูปตามชื่อผู้ใช้ที่กำหนดใน config.js
    for (let i = 0; i < USER_LABELS.length; i++) {
        const label = USER_LABELS[i]; // เช่น 'john_doe'
        const userDescriptors = [];
        
        // เราจะพยายามโหลดภาพ 3 ภาพต่อผู้ใช้หนึ่งคน
        for (let j = 1; j <= 3; j++) {
            try {
                // สร้าง Object Image HTML
                const img = await faceapi.fetchImage(`/images/${label}/${j}.jpg`);
                
                // ตรวจจับและสร้าง Face Descriptor
                const detection = await faceapi.detectSingleFace(img).withFaceLandmarks().withFaceDescriptor();
                
                if (detection && detection.descriptor) {
                    userDescriptors.push(detection.descriptor);
                } else {
                    console.warn(`No face detected in image: ${label}/${j}.jpg`);
                }
            } catch (err) {
                console.error(`Error loading image ${label}/${j}.jpg:`, err);
            }
        }
        
        // ถ้ามี Descriptors อย่างน้อย 1 อัน ให้สร้าง LabeledDescriptor
        if (userDescriptors.length > 0) {
            descriptors.push(new faceapi.LabeledFaceDescriptors(label, userDescriptors));
            statusDiv.textContent = `Loaded ${userDescriptors.length} descriptors for ${label}...`;
        }
    }
    
    // สร้าง FaceMatcher จากฐานข้อมูล Descriptors ที่สร้างขึ้น
    return new faceapi.FaceMatcher(descriptors, FACE_MATCH_THRESHOLD);
}


// 3. ปรับฟังก์ชันเริ่มต้น (startVideo)

async function startVideo() {
    statusDiv.textContent = 'Models loaded. Loading face descriptors...';
    
    // โหลดฐานข้อมูลใบหน้าก่อนเปิดกล้อง
    faceMatcher = await loadLabeledFaceDescriptors(); 
    
    if (faceMatcher.labeledDescriptors.length === 0) {
        statusDiv.textContent = 'WARNING: No face descriptors loaded. Recognition will not work.';
    } else {
        statusDiv.textContent = `Successfully loaded ${faceMatcher.labeledDescriptors.length} user labels. Starting video...`;
    }
    
    // ... (ส่วนเปิดกล้องเหมือนเดิม)
}


// 4. ปรับฟังก์ชันตรวจจับใบหน้า (detectFace)

async function detectFace() {
    // ... (โค้ดส่วนต้นเหมือนเดิม)
    
    const detections = await faceapi.detectSingleFace(video).withFaceLandmarks().withFaceDescriptor();

    // ... (โค้ดส่วนปรับขนาด)
    
    if (resizedDetections) {
        // --- ส่วนที่เพิ่มสำหรับการระบุตัวตน ---
        const currentDescriptor = resizedDetections.descriptor;
        const bestMatch = faceMatcher.findBestMatch(currentDescriptor);
        // ------------------------------------
        
        faceapi.draw.drawDetections(canvas, resizedDetections);
        
        // แสดงผลลัพธ์
        const box = resizedDetections.detection.box;
        const drawBox = new faceapi.draw.DrawBox(box, { label: bestMatch.toString() });
        drawBox.draw(canvas);
        
        if (bestMatch.label !== 'unknown') {
            statusDiv.textContent = `Welcome, ${bestMatch.label.toUpperCase()}! Ready to check-in.`;
            checkinBtn.disabled = false;
            // เก็บชื่อผู้ใช้ที่ระบุได้
            checkinBtn.dataset.userLabel = bestMatch.label; 
        } else {
            statusDiv.textContent = 'Face detected, but user unknown.';
            checkinBtn.disabled = true;
        }
        
    } else {
        statusDiv.textContent = 'No face detected. Please face the camera.';
        checkinBtn.disabled = true;
    }
}
// ... (ส่วน Check-in ต่อไป)